<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Flexst√§mpling</title>

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 1rem;
    }
    .app {
      max-width: 480px;
      margin: auto;
      background: white;
      padding: 1rem;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    h1, h2 { text-align: center; }
    label { display: block; margin-top: 1rem; }
    input, button {
      width: 100%;
      padding: 0.6rem;
      margin-top: 0.3rem;
      font-size: 1rem;
    }
    button { cursor: pointer; margin-top: 0.8rem; }
    .row { display: flex; gap: 0.5rem; }
    .row button { flex: 1; }
    .card {
      background: #f0f0f0;
      padding: 0.7rem;
      border-radius: 8px;
      margin-top: 0.5rem;
    }
    .pos { color: green; }
    .neg { color: red; }
  </style>
</head>

<body>

<!-- LOGIN -->
<div id="login" class="app">
  <h1>Flexst√§mpling</h1>
  <label>Anv√§ndarkod</label>
  <input id="pin" placeholder="t.ex. alex eller 1234">
  <button onclick="login()">Logga in</button>
</div>

<!-- APP -->
<div id="app" class="app" style="display:none;">
  <p>
    Inloggad som <strong id="user"></strong>
    <button onclick="logout()">Logga ut</button>
  </p>

  <h2>Ny dag</h2>

  <label>Datum</label>
  <input type="date" id="date">

  <label>Start</label>
  <input type="time" id="start">

  <label>Slut</label>
  <input type="time" id="end">

  <label>Rast (min)</label>
  <input type="number" id="break" value="60">

  <div class="row">
    <button onclick="stamp('start')">‚ñ∂Ô∏è In nu</button>
    <button onclick="stamp('end')">‚èπÔ∏è Ut nu</button>
  </div>

  <button onclick="saveDay()">üíæ Spara dagen</button>

  <h2>Totalt flexsaldo</h2>
  <div id="totalFlex" class="card"></div>

  <h2>Denna vecka</h2>
  <div id="week" class="card"></div>

  <h2>Dag-historik</h2>
  <div id="days"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    doc,
    setDoc,
    getDocs,
    query
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCSkjN-SafQEZrbhhhu-Mue4hf3GfADN3w",
    authDomain: "flexstampling.firebaseapp.com",
    projectId: "flexstampling"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const STANDARD_MIN = 480;
  let userId = null;
  let daysData = [];

  const dateEl = document.getElementById("date");
  const startEl = document.getElementById("start");
  const endEl = document.getElementById("end");
  const breakEl = document.getElementById("break");

  dateEl.value = new Date().toISOString().slice(0,10);

  window.login = () => {
    const pin = document.getElementById("pin").value.trim();
    if (!pin) return;
    userId = pin;
    localStorage.setItem("flexUser", pin);
    showApp();
  };

  window.logout = () => {
    localStorage.removeItem("flexUser");
    location.reload();
  };

  function showApp() {
    document.getElementById("login").style.display = "none";
    document.getElementById("app").style.display = "block";
    document.getElementById("user").textContent = userId;
    loadDays();
  }

  window.stamp = type => {
    const t = new Date().toTimeString().slice(0,5);
    document.getElementById(type).value = t;
  };

  function minutes(a,b){
    const [h1,m1]=a.split(":").map(Number);
    const [h2,m2]=b.split(":").map(Number);
    return h2*60+m2-(h1*60+m1);
  }

  window.saveDay = async () => {
    const date = dateEl.value;
    const start = startEl.value;
    const end = endEl.value;
    const br = +breakEl.value;

    if (!date || !start || !end) {
      alert("Fyll i datum, start och slut");
      return;
    }

    const worked = minutes(start,end) - br;
    const flex = worked - STANDARD_MIN;

    await setDoc(doc(db,"users",userId,"days",date),{
      date,start,end,br,worked,flex
    });

    alert("Dagen sparad üëç");
    loadDays();
  };

  async function loadDays(){
    daysData = [];
    const q = query(collection(db,"users",userId,"days"));
    const snap = await getDocs(q);
    snap.forEach(d => daysData.push(d.data()));
    daysData.sort((a,b)=>a.date.localeCompare(b.date));
    render();
  }

  function render(){
    let total = 0;
    let weekFlex = 0;
    let html = "";
    const currentWeek = getWeek(new Date());

    daysData.forEach(d=>{
      total += d.flex;
      if (getWeek(new Date(d.date)) === currentWeek) weekFlex += d.flex;
      html += `
        <div class="card">
          ${d.date} ‚Äî
          <span class="${d.flex>=0?'pos':'neg'}">
            ${d.flex>=0?'+':''}${d.flex} min
          </span>
        </div>`;
    });

    totalFlex.innerHTML =
      `<strong class="${total>=0?'pos':'neg'}">${total} min</strong>`;
    week.innerHTML =
      `Veckoflex: <strong class="${weekFlex>=0?'pos':'neg'}">${weekFlex} min</strong>`;
    days.innerHTML = html || "Inga dagar √§nnu";
  }

  function getWeek(d){
    d = new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate()));
    const day = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - day);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  }

  const savedUser = localStorage.getItem("flexUser");
  if (savedUser) {
    userId = savedUser;
    showApp();
  }
</script>

</body>
</html>
