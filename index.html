<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flexst√§mpling</title>

<link rel="manifest" href="manifest.json">

<style>
body {
  font-family: system-ui, sans-serif;
  background:#f4f4f4;
  padding:1rem;
}
.app {
  max-width:520px;
  margin:auto;
  background:white;
  padding:1rem;
  border-radius:12px;
}
label { display:block; margin-top:1rem; }
input, button {
  width:100%;
  padding:0.6rem;
  margin-top:0.3rem;
}
button { margin-top:0.6rem; cursor:pointer; }
button.danger {
  background:#ffdddd;
  border:1px solid #cc0000;
}
.card {
  background:#eee;
  padding:0.6rem;
  margin-top:0.4rem;
  border-radius:6px;
  cursor:pointer;
}
.pos { color:green; }
.neg { color:red; }
.summary {
  background:#f0f0f0;
  padding:0.6rem;
  border-radius:6px;
  margin-top:0.6rem;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginView" class="app">
  <h2>Flexst√§mpling</h2>
  <label>Anv√§ndarkod</label>
  <input id="pinInput" placeholder="t.ex. alex">
  <button onclick="login()">Logga in</button>
</div>

<!-- APP -->
<div id="appView" class="app" style="display:none;">
  <p>
    Inloggad som <strong id="userLabel"></strong>
    <button onclick="logout()">Logga ut</button>
  </p>

  <h3>Registrera / redigera dag</h3>

  <label>Datum</label>
  <input type="date" id="dateInput">

  <label>Start</label>
  <input type="time" id="startInput">

  <label>Slut</label>
  <input type="time" id="endInput">

  <label>Rast (min)</label>
  <input type="number" id="breakInput" value="60">

  <button onclick="stampNow('start')">‚ñ∂Ô∏è St√§mpla in nu</button>
  <button onclick="stampNow('end')">‚èπÔ∏è St√§mpla ut nu</button>

  <button onclick="saveDay()">üíæ Spara dagen</button>
  <button id="deleteBtn" class="danger" onclick="deleteDay()" style="display:none;">
    üóëÔ∏è Radera dagen
  </button>

  <h3>Veckovy</h3>
  <label>V√§lj vecka</label>
  <input type="week" id="weekInput" onchange="render()">

  <div id="weekSummary" class="summary"></div>

  <h3>Totalt flexsaldo</h3>
  <div id="totalFlex" class="summary"></div>

  <h3>Dag-historik (klicka f√∂r att redigera)</h3>
  <div id="daysContainer"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, doc, setDoc, getDocs, deleteDoc }
  from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyCSkjN-SafQEZrbhhhu-Mue4hf3GfADN3w",
  projectId: "flexstampling"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* State */
const STANDARD_MIN = 480;
let userId = null;
let daysData = [];

/* DOM */
const loginView = document.getElementById("loginView");
const appView = document.getElementById("appView");
const pinInput = document.getElementById("pinInput");
const userLabel = document.getElementById("userLabel");
const dateInput = document.getElementById("dateInput");
const startInput = document.getElementById("startInput");
const endInput = document.getElementById("endInput");
const breakInput = document.getElementById("breakInput");
const weekInput = document.getElementById("weekInput");
const weekSummary = document.getElementById("weekSummary");
const totalFlexDiv = document.getElementById("totalFlex");
const daysContainer = document.getElementById("daysContainer");
const deleteBtn = document.getElementById("deleteBtn");

/* Init */
dateInput.valueAsDate = new Date();
weekInput.value = isoWeek(new Date());

/* Login */
window.login = function () {
  const pin = pinInput.value.trim();
  if (!pin) return alert("Ange anv√§ndarkod");
  userId = pin;
  localStorage.setItem("flexUser", pin);
  loginView.style.display = "none";
  appView.style.display = "block";
  userLabel.textContent = userId;
  loadDays();
};

window.logout = function () {
  localStorage.removeItem("flexUser");
  location.reload();
};

/* Helpers */
function minutes(a, b) {
  const [h1, m1] = a.split(":").map(Number);
  const [h2, m2] = b.split(":").map(Number);
  return h2 * 60 + m2 - (h1 * 60 + m1);
}

/* St√§mpla NU */
window.stampNow = function(type) {
  const now = new Date();
  const hh = String(now.getHours()).padStart(2,"0");
  const mm = String(now.getMinutes()).padStart(2,"0");
  const time = `${hh}:${mm}`;
  if (type === "start") startInput.value = time;
  if (type === "end") endInput.value = time;
  dateInput.valueAsDate = new Date();
};

/* Spara */
window.saveDay = async function () {
  if (!dateInput.value || !startInput.value || !endInput.value)
    return alert("Fyll i datum, start och slut");

  const worked =
    minutes(startInput.value, endInput.value) -
    Number(breakInput.value);

  const flex = worked - STANDARD_MIN;

  await setDoc(doc(db, "users", userId, "days", dateInput.value), {
    date: dateInput.value,
    start: startInput.value,
    end: endInput.value,
    br: Number(breakInput.value),
    worked,
    flex,
    updatedAt: new Date().toISOString()
  });

  alert("‚úÖ Dagen sparad");
  loadDays();
};

/* RADERA DAG */
window.deleteDay = async function () {
  const date = dateInput.value;
  if (!date) return;

  if (!confirm(`Vill du verkligen radera ${date}?`)) return;

  await deleteDoc(doc(db, "users", userId, "days", date));

  // Rensa formul√§ret
  startInput.value = "";
  endInput.value = "";
  breakInput.value = 60;
  deleteBtn.style.display = "none";

  loadDays();
};

/* Load & render */
async function loadDays() {
  daysData = [];
  const snap = await getDocs(collection(db, "users", userId, "days"));
  snap.forEach(d => daysData.push(d.data()));
  daysData.sort((a, b) => a.date.localeCompare(b.date));
  render();
}

window.render = function () {
  daysContainer.innerHTML = "";
  let totalFlex = 0;
  let weekFlex = 0;
  let weekWorked = 0;

  const [ws, we] = weekRange(weekInput.value);

  daysData.forEach(d => {
    totalFlex += d.flex;
    const dt = new Date(d.date);
    if (dt >= ws && dt <= we) {
      weekFlex += d.flex;
      weekWorked += d.worked;
    }

    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      ${d.date} ‚Äì
      <span class="${d.flex >= 0 ? 'pos' : 'neg'}">
        ${d.flex >= 0 ? '+' : ''}${d.flex} min
      </span>`;
    div.onclick = () => loadDay(d);
    daysContainer.appendChild(div);
  });

  totalFlexDiv.innerHTML = `<strong>${totalFlex} min</strong>`;
  weekSummary.innerHTML =
    `Arbetade timmar: <strong>${(weekWorked/60).toFixed(1)} h</strong><br>
     Veckoflex: <strong class="${weekFlex>=0?'pos':'neg'}">${weekFlex} min</strong>`;
};

function loadDay(d) {
  dateInput.value = d.date;
  startInput.value = d.start;
  endInput.value = d.end;
  breakInput.value = d.br;
  deleteBtn.style.display = "block";
}

/* Week helpers */
function weekRange(w) {
  const [y, n] = w.split("-W").map(Number);
  const d = new Date(y, 0, 1 + (n - 1) * 7);
  while (d.getDay() !== 1) d.setDate(d.getDate() - 1);
  const s = new Date(d);
  const e = new Date(d);
  e.setDate(d.getDate() + 6);
  return [s, e];
}

function isoWeek(d) {
  d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
  const y = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
  const w = Math.ceil((((d - y) / 86400000) + 1) / 7);
  return `${d.getUTCFullYear()}-W${String(w).padStart(2,"0")}`;
}

/* Auto-login */
const saved = localStorage.getItem("flexUser");
if (saved) {
  pinInput.value = saved;
  login();
}
</script>

</body>
</html>
