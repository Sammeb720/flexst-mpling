<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flexst√§mpling</title>

<link rel="manifest" href="manifest.json">

<style>
body {
  font-family: system-ui, sans-serif;
  background:#f4f4f4;
  padding:1rem;
}
.app {
  max-width:520px;
  margin:auto;
  background:white;
  padding:1rem;
  border-radius:12px;
}
label { display:block; margin-top:1rem; }
input, button {
  width:100%;
  padding:0.6rem;
  margin-top:0.3rem;
}
button { margin-top:0.6rem; cursor:pointer; }
.summary {
  background:#f0f0f0;
  padding:0.6rem;
  border-radius:6px;
  margin-top:0.6rem;
}
.dayRow {
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:#eee;
  padding:0.6rem;
  margin-top:0.4rem;
  border-radius:6px;
}
.dayText { cursor:pointer; }
.deleteBtn {
  background:#ffdddd;
  border:1px solid #cc0000;
  color:#900;
  padding:0.3rem 0.6rem;
}
.pos { color:green; }
.neg { color:red; }
</style>
</head>

<body>

<div id="loginView" class="app">
  <h2>Flexst√§mpling</h2>
  <label>Anv√§ndarkod</label>
  <input id="pinInput" placeholder="t.ex. alex">
  <button onclick="login()">Logga in</button>
</div>

<div id="appView" class="app" style="display:none;">
  <p>
    Inloggad som <strong id="userLabel"></strong>
    <button onclick="logout()">Logga ut</button>
  </p>

  <label>Datum</label>
  <input type="date" id="dateInput">

  <label>Start</label>
  <input type="time" id="startInput">

  <label>Slut</label>
  <input type="time" id="endInput">

  <label>Rast (min)</label>
  <input type="number" id="breakInput" value="60">

  <button onclick="stampNow('start')">‚ñ∂Ô∏è St√§mpla in nu</button>
  <button onclick="stampNow('end')">‚èπÔ∏è St√§mpla ut nu</button>
  <button onclick="saveDay()">üíæ Spara dagen</button>

  <h3>Vecka</h3>
  <input type="week" id="weekInput" onchange="render()">

  <div id="weekSummary" class="summary"></div>
  <div id="totalFlex" class="summary"></div>

  <h3>Dagar (vald vecka)</h3>
  <div id="daysContainer"></div>
</div>

<!-- üî• Firebase v9 COMPAT (INGA MODULES) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* Firebase */
firebase.initializeApp({
  apiKey: "AIzaSyCSkjN-SafQEZrbhhhu-Mue4hf3GfADN3w",
  projectId: "flexstampling"
});
const db = firebase.firestore();

/* State */
const STANDARD_MIN = 480;
let userId = null;
let daysData = [];

/* DOM */
const loginView = document.getElementById("loginView");
const appView = document.getElementById("appView");
const pinInput = document.getElementById("pinInput");
const userLabel = document.getElementById("userLabel");
const dateInput = document.getElementById("dateInput");
const startInput = document.getElementById("startInput");
const endInput = document.getElementById("endInput");
const breakInput = document.getElementById("breakInput");
const weekInput = document.getElementById("weekInput");
const daysContainer = document.getElementById("daysContainer");
const totalFlexDiv = document.getElementById("totalFlex");
const weekSummary = document.getElementById("weekSummary");

/* Init */
dateInput.valueAsDate = new Date();
weekInput.value = isoWeek(new Date());

/* Login */
function login() {
  const pin = pinInput.value.trim();
  if (!pin) return alert("Ange anv√§ndarkod");
  userId = pin;
  localStorage.setItem("flexUser", pin);
  loginView.style.display = "none";
  appView.style.display = "block";
  userLabel.textContent = userId;
  loadDays();
}

function logout() {
  localStorage.removeItem("flexUser");
  location.reload();
}

function minutes(a,b){
  const [h1,m1]=a.split(":").map(Number);
  const [h2,m2]=b.split(":").map(Number);
  return h2*60+m2-(h1*60+m1);
}

function stampNow(type){
  const t=new Date().toTimeString().slice(0,5);
  if(type==="start") startInput.value=t;
  if(type==="end") endInput.value=t;
  dateInput.valueAsDate=new Date();
}

async function saveDay(){
  const worked=minutes(startInput.value,endInput.value)-Number(breakInput.value);
  const flex=worked-STANDARD_MIN;
  await db.collection("users").doc(userId).collection("days")
    .doc(dateInput.value).set({
      date:dateInput.value,start:startInput.value,end:endInput.value,
      br:Number(breakInput.value),worked,flex
    });
  loadDays();
}

async function loadDays(){
  daysData=[];
  const snap=await db.collection("users").doc(userId).collection("days").get();
  snap.forEach(d=>daysData.push(d.data()));
  render();
}

function render(){
  daysContainer.innerHTML="";
  let total=0, weekFlex=0, weekWorked=0;
  const [ws,we]=weekRange(weekInput.value);

  daysData.forEach(d=>{
    total+=d.flex;
    const dt=new Date(d.date);
    if(dt<ws||dt>we)return;

    weekFlex+=d.flex;
    weekWorked+=d.worked;

    const row=document.createElement("div");
    row.className="dayRow";
    row.innerHTML=`${d.date} ‚Äì ${d.flex} min
      <button class="deleteBtn" onclick="deleteDay('${d.date}')">Radera</button>`;
    row.onclick=()=>loadDay(d);
    daysContainer.appendChild(row);
  });

  totalFlexDiv.innerHTML=`Totalt flex: ${total} min`;
  weekSummary.innerHTML=`Veckoflex: ${weekFlex} min (${(weekWorked/60).toFixed(1)} h)`;
}

function deleteDay(date){
  if(!confirm("Radera "+date+"?"))return;
  db.collection("users").doc(userId).collection("days").doc(date).delete();
  loadDays();
}

function loadDay(d){
  dateInput.value=d.date;
  startInput.value=d.start;
  endInput.value=d.end;
  breakInput.value=d.br;
}

function weekRange(w){
  const[y,n]=w.split("-W").map(Number);
  const d=new Date(y,0,1+(n-1)*7);
  while(d.getDay()!=1)d.setDate(d.getDate()-1);
  const s=new Date(d),e=new Date(d);e.setDate(d.getDate()+6);
  return[s,e];
}
function isoWeek(d){
  d=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate()));
  d.setUTCDate(d.getUTCDate()+4-(d.getUTCDay()||7));
  const y=new Date(Date.UTC(d.getUTCFullYear(),0,1));
  const w=Math.ceil((((d-y)/86400000)+1)/7);
  return`${d.getUTCFullYear()}-W${String(w).padStart(2,"0")}`;
}

const saved=localStorage.getItem("flexUser");
if(saved){pinInput.value=saved;login();}
</script>

</body>
</html>
