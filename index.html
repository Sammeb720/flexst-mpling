<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FlexstÃ¤mpling</title>

<style>
body {
  font-family: system-ui, sans-serif;
  background:#f4f4f4;
  padding:1rem;
}
.app {
  max-width:520px;
  margin:auto;
  background:white;
  padding:1rem;
  border-radius:12px;
}
label { display:block; margin-top:1rem; }
input, button {
  width:100%;
  padding:0.6rem;
  margin-top:0.3rem;
}
button { margin-top:0.8rem; }
.card {
  background:#eee;
  padding:0.6rem;
  margin-top:0.4rem;
  border-radius:6px;
  cursor:pointer;
}
.pos { color:green; }
.neg { color:red; }
.summary {
  background:#f0f0f0;
  padding:0.6rem;
  border-radius:6px;
  margin-top:0.6rem;
}
</style>
</head>

<body>

<div id="loginView" class="app">
  <h2>FlexstÃ¤mpling</h2>
  <label>AnvÃ¤ndarkod</label>
  <input id="pin">
  <button onclick="login()">Logga in</button>
</div>

<div id="appView" class="app" style="display:none;">
  <p>
    Inloggad som <strong id="userLabel"></strong>
    <button onclick="logout()">Logga ut</button>
  </p>

  <h3>Registrera dag</h3>

  <label>Datum</label>
  <input type="date" id="date">

  <label>Start</label>
  <input type="time" id="start">

  <label>Slut</label>
  <input type="time" id="end">

  <label>Rast (min)</label>
  <input type="number" id="break" value="60">

  <button onclick="saveDay()">ðŸ’¾ Spara dagen</button>

  <h3>Veckovy</h3>
  <label>VÃ¤lj vecka</label>
  <input type="week" id="week" onchange="render()">

  <div id="weekSummary" class="summary"></div>

  <h3>Totalt flexsaldo</h3>
  <div id="totalFlex" class="summary"></div>

  <h3>Dag-historik</h3>
  <div id="days"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, doc, setDoc, getDocs } 
  from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCSkjN-SafQEZrbhhhu-Mue4hf3GfADN3w",
  projectId: "flexstampling"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const STANDARD = 480;
let userId = null;
let days = [];

date.valueAsDate = new Date();
week.value = isoWeek(new Date());

window.login = function () {
  const pin = document.getElementById("pin").value.trim();
  if (!pin) return;
  userId = pin;
  localStorage.setItem("flexUser", pin);
  loginView.style.display = "none";
  appView.style.display = "block";
  userLabel.textContent = userId;
  loadDays();
};

window.logout = function () {
  localStorage.clear();
  location.reload();
};

window.saveDay = async function () {
  if (!date.value || !start.value || !end.value) return;

  const worked =
    diff(start.value, end.value) - Number(break.value);
  const flex = worked - STANDARD;

  await setDoc(doc(db,"users",userId,"days",date.value),{
    date: date.value,
    start: start.value,
    end: end.value,
    br: Number(break.value),
    worked,
    flex
  });

  loadDays();
};

async function loadDays(){
  days = [];
  const snap = await getDocs(collection(db,"users",userId,"days"));
  snap.forEach(d => days.push(d.data()));
  days.sort((a,b)=>a.date.localeCompare(b.date));
  render();
}

window.render = function () {
  days.innerHTML = "";
  let total = 0, weekFlex = 0, weekWorked = 0;
  const [ws,we] = weekRange(week.value);

  days.forEach(d=>{
    total += d.flex;
    const dt = new Date(d.date);
    if (dt>=ws && dt<=we){
      weekFlex += d.flex;
      weekWorked += d.worked;
    }
    const div = document.createElement("div");
    div.className="card";
    div.textContent = `${d.date} â€“ ${d.flex} min`;
    div.onclick=()=>loadDay(d);
    days.appendChild(div);
  });

  totalFlex.innerHTML = total+" min";
  weekSummary.innerHTML =
    `Arbetade timmar: ${(weekWorked/60).toFixed(1)} h<br>
     Veckoflex: ${weekFlex} min`;
};

function loadDay(d){
  date.value=d.date;
  start.value=d.start;
  end.value=d.end;
  break.value=d.br;
}

function diff(a,b){
  const [h1,m1]=a.split(":").map(Number);
  const [h2,m2]=b.split(":").map(Number);
  return h2*60+m2-(h1*60+m1);
}

function weekRange(w){
  const [y,n]=w.split("-W").map(Number);
  const d=new Date(y,0,1+(n-1)*7);
  while(d.getDay()!=1)d.setDate(d.getDate()-1);
  const s=new Date(d),e=new Date(d);e.setDate(d.getDate()+6);
  return[s,e];
}

function isoWeek(d){
  d=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate()));
  d.setUTCDate(d.getUTCDate()+4-(d.getUTCDay()||7));
  const y=new Date(Date.UTC(d.getUTCFullYear(),0,1));
  const w=Math.ceil((((d-y)/86400000)+1)/7);
  return `${d.getUTCFullYear()}-W${String(w).padStart(2,"0")}`;
}

const saved = localStorage.getItem("flexUser");
if(saved){ userId=saved; login(); }
</script>

</body>
</html>
