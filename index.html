<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Flexst√§mpling</title>

<style>
body {
  font-family: system-ui, sans-serif;
  background: #f4f4f4;
  margin: 0;
  padding: 1rem;
}
.app {
  max-width: 520px;
  margin: auto;
  background: white;
  padding: 1rem;
  border-radius: 12px;
}
label { display:block; margin-top:1rem; }
input, button {
  width: 100%;
  padding: 0.6rem;
  margin-top: 0.3rem;
}
button { margin-top: 0.8rem; }
.card {
  background:#eee;
  padding:0.6rem;
  border-radius:6px;
  margin-top:0.4rem;
  cursor:pointer;
}
.pos { color: green; }
.neg { color: red; }
.summary {
  background:#f0f0f0;
  padding:0.6rem;
  border-radius:6px;
  margin-top:0.6rem;
}
</style>
</head>

<body>

<div id="login" class="app">
  <h2>Flexst√§mpling</h2>
  <label>Anv√§ndarkod</label>
  <input id="pin" placeholder="t.ex. alex">
  <button onclick="login()">Logga in</button>
</div>

<div id="app" class="app" style="display:none;">
  <p>
    Inloggad som <strong id="user"></strong>
    <button onclick="logout()">Logga ut</button>
  </p>

  <h3>Registrera dag</h3>

  <label>Datum</label>
  <input type="date" id="date">

  <label>Start</label>
  <input type="time" id="start">

  <label>Slut</label>
  <input type="time" id="end">

  <label>Rast (min)</label>
  <input type="number" id="break" value="60">

  <button onclick="saveDay()">üíæ Spara dagen</button>

  <h3>Veckovy</h3>

  <label>V√§lj vecka</label>
  <input type="week" id="weekPicker">

  <div class="summary" id="weekSummary"></div>

  <h3>Totalt flexsaldo</h3>
  <div class="summary" id="totalFlex"></div>

  <h3>Dag-historik (klicka f√∂r att redigera)</h3>
  <div id="days"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, doc, setDoc, getDocs, query
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCSkjN-SafQEZrbhhhu-Mue4hf3GfADN3w",
  projectId: "flexstampling"
};

const appFB = initializeApp(firebaseConfig);
const db = getFirestore(appFB);

const STANDARD = 480;
let userId = null;
let days = [];

const dateEl = document.getElementById("date");
const startEl = document.getElementById("start");
const endEl = document.getElementById("end");
const breakEl = document.getElementById("break");
const weekPicker = document.getElementById("weekPicker");

dateEl.valueAsDate = new Date();
weekPicker.value = getISOWeekString(new Date());

window.login = () => {
  const pin = document.getElementById("pin").value.trim();
  if (!pin) return;
  userId = pin;
  localStorage.setItem("flexUser", pin);
  showApp();
};

window.logout = () => {
  localStorage.clear();
  location.reload();
};

function showApp() {
  login.style.display = "none";
  app.style.display = "block";
  user.textContent = userId;
  loadDays();
}

function minutes(a,b){
  const [h1,m1]=a.split(":").map(Number);
  const [h2,m2]=b.split(":").map(Number);
  return h2*60+m2-(h1*60+m1);
}

window.saveDay = async () => {
  const date = dateEl.value;
  const start = startEl.value;
  const end = endEl.value;
  const br = +breakEl.value;

  if (!date || !start || !end) {
    alert("Fyll i datum, start och slut");
    return;
  }

  const worked = minutes(start,end) - br;
  const flex = worked - STANDARD;

  await setDoc(doc(db,"users",userId,"days",date),{
    date,start,end,br,worked,flex
  });

  loadDays();
};

async function loadDays(){
  days = [];
  const snap = await getDocs(query(collection(db,"users",userId,"days")));
  snap.forEach(d => days.push(d.data()));
  days.sort((a,b)=>a.date.localeCompare(b.date));
  render();
}

function render(){
  let totalFlex = 0;
  daysDiv.innerHTML = "";

  const [weekStart, weekEnd] = getWeekRange(weekPicker.value);
  let weekMinutes = 0;
  let weekFlex = 0;

  days.forEach(d=>{
    totalFlex += d.flex;

    const dayDate = new Date(d.date);
    if (dayDate >= weekStart && dayDate <= weekEnd) {
      weekMinutes += d.worked;
      weekFlex += d.flex;
    }

    const el = document.createElement("div");
    el.className = "card";
    el.innerHTML = `
      ${d.date} ‚Äì
      <span class="${d.flex>=0?'pos':'neg'}">
        ${d.flex>=0?'+':''}${d.flex} min
      </span>`;
    el.onclick = () => loadDay(d);
    daysDiv.appendChild(el);
  });

  totalFlexDiv.innerHTML =
    `<strong>${(totalFlex/60).toFixed(1)} h (${totalFlex} min)</strong>`;

  weekSummary.innerHTML = `
    Arbetade timmar: <strong>${(weekMinutes/60).toFixed(1)} h</strong><br>
    Veckoflex: <strong class="${weekFlex>=0?'pos':'neg'}">
      ${weekFlex>=0?'+':''}${weekFlex} min
    </strong>`;
}

function loadDay(d){
  dateEl.value = d.date;
  startEl.value = d.start;
  endEl.value = d.end;
  breakEl.value = d.br;
}

weekPicker.onchange = render;

function getWeekRange(weekValue){
  const [year, week] = weekValue.split("-W").map(Number);
  const firstDay = new Date(year,0,1);
  const daysOffset = (week-1)*7;
  const monday = new Date(firstDay.setDate(firstDay.getDate() + daysOffset));
  while (monday.getDay() !== 1) monday.setDate(monday.getDate() - 1);
  const sunday = new Date(monday);
  sunday.setDate(monday.getDate() + 6);
  return [monday, sunday];
}

function getISOWeekString(d){
  const date = new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate()));
  const day = date.getUTCDay() || 7;
  date.setUTCDate(date.getUTCDate() + 4 - day);
  const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
  return `${date.getUTCFullYear()}-W${String(weekNo).padStart(2,"0")}`;
}

const saved = localStorage.getItem("flexUser");
if (saved) {
  userId = saved;
  showApp();
}
</script>

</body>
</html>
